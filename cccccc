%%[
Set @symkey = 'ef875004-a0c7-4fa5-a8c9-8fd73206c4d8'
Set @IV = '716ea8bd-7f9e-4ecb-8943-e0014bbcbb61'
Set @salt = '8b0988eb-19b5-4006-b740-027c1d956b53'

 Set @lookuptoken_1 = Lookup("D&B_Authentication_DE","Token","Flag","True")
 Set @lookuptoken = DecryptSymmetric(@lookuptoken_1,'AES',@symkey,@null,@salt,@null,@IV,@null)

 Set @lookuptoken_2 = Lookup("TokensDataExtension","Token","Flag","SFSC_Acces_Token")
 Set @SFSC_accestoken = DecryptSymmetric(@lookuptoken_2,'AES',@symkey,@null,@salt,@null,@IV,@null)
 
 Set @lookuptoken_3 = Lookup("TokensDataExtension","Token","Flag","SFMC_Journey_Token")
 Set @SFMC_Journey_Token = DecryptSymmetric(@lookuptoken_3,'AES',@symkey,@null,@salt,@null,@IV,@null)
 
 
 
 Set @restUrl_link = Lookup("TokensDataExtension","restUrl","Flag","SFMC_Journey_Token")
 
 
 Set @restUrl_link1 = Lookup("TokensDataExtension","restUrl","Flag","SFSC_Acces_Token")
 
 
]%%



<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shell SFMC Lead Capture Form</title>
  <link rel="stylesheet" href="https://cloud.fleetsolutions.shell.com/new_form_nl_css_dev">

  <script defer src="https://cloud.fleetsolutions.shell.com/new_form_nl_js_dev"></script>
  <script type="text/javascript"
    src="//s00.static-shell.com/apps/shell-common/components/components/iframe/clientlib/external.min.js"></script>

  <script runat="server">
    Platform.Response.SetResponseHeader("Strict-Transport-Security", "max-age=300");
    Platform.Response.SetResponseHeader("X-XSS-Protection", "1; mode=block");
    Platform.Response.SetResponseHeader("X-Content-Type-Options", "nosniff");
    Platform.Response.SetResponseHeader("Referrer-Policy", "strict-origin-when-cross-origin");
    Platform.Response.SetResponseHeader("X-Permitted-Cross-Domain-Policies", "none");
    Platform.Response.SetResponseHeader("Feature-Policy", "camera 'none'; fullscreen 'self'; geolocation *; microphone 'self'");
    Platform.Response.SetResponseHeader("X-Frame-Options","allow-from https://www.oneweb.shell.com/ https://www.shell.nl/");
  </script>
  

 %%[ var @firstname, @lastname, @contactNumber, @cars, @trucks, @privacy, @marketingcommsvar, @FS_Opt_In__c,
 @HasOptedOutOfEmail, @FS_Phone_Opt_In__c, @FS_HasOptedOutOfPhone__c, @companyname, @campaigncode, @country,@jobTitle,
 @emailAddress, @ownerId_Josephine

 SET @thankyou = 'block'
 SET @thank_you_block = 'none'
set @campaigncodevar =RequestParameter("campaigncode")
set @campaignIdvar =RequestParameter("campaignId")
set @campaigncodevar = "CMP-01318-R0T5P9"
set @campaignIdvar = "7013N000000jI2gQAE"
set @formnamevar =RequestParameter("FormName")

 IF RequestParameter("submitted") == true THEN

 set @firstname = RequestParameter("firstname")
 set @lastname = RequestParameter("lastname")
 set @companyname = RequestParameter("companyName")
  set @jobTitle = RequestParameter("jobTitle")
 set @emailAddress = RequestParameter("email")
 set @contactnumber = RequestParameter("phonenumber")
  set @companyZipvar = RequestParameter("companyZip")
 set @cars = RequestParameter("cars")
 set @trucks = RequestParameter("trucks")
  set @additionalInfo = RequestParameter("additionalInfo")
 SET @privacy = 'True'
 SET @FS_Opt_In__c = 'true'
 SET @HasOptedOutOfEmail = 'false'
 SET @FS_Phone_Opt_In__c = 'true'
 SET @FS_HasOptedOutOfPhone__c = 'false'
 SET @thankyou = 'none'
 SET @thank_you_block = 'block'
 SET @campaignCode = @campaigncodevar
 SET @campaignId = @campaignIdvar
 SET @country = 'Netherlands'
 SET @countryfield = 'NL'
 set @priority = 'High'
 set @taskType = 'A2Z'
 set @status = 'Open'
 SET @TodayDate = Now(1)
 SET @subject = 'New lead for SFS'
 SET @Description = 'New lead is coming in via the website and has been assigned to correct account manager.'
 SET @ownerId_Josephine = '0057S000003LJWNQA4'
 
 Set @today_DB = FormatDate(Now(),"iso")

 set @dayFullName = FormatDate(@TodayDate,"ddddd")

 If @dayFullName == 'Monday' or @dayFullName == 'Tuesday' Then
 Set @TaskDueDate = FormatDate(DateAdd(@TodayDate, 3, "D"),"YYYY-MM-DD")
 ELSEIF @dayFullName == 'Wednesday' or @dayFullName == 'Thursday' or @dayFullName == 'Friday' or @dayFullName ==
 'Saturday' Then
 Set @TaskDueDate = FormatDate(DateAdd(@TodayDate, 5, "D"),"YYYY-MM-DD")
 ELSEIF @dayFullName == 'Sunday' Then
 Set @TaskDueDate = FormatDate(DateAdd(@TodayDate, 4, "D"),"YYYY-MM-DD")
 ENDIF

SET @duns = RequestParameter("duns")

 SET @campaginCodeForContact = @campaigncodevar


 /************* Checking if campagin code already exist or not in FS_Campaign_Code_Mktg__c ****************/

 IF indexOf(@existingContactCampaignCode, @campaginCodeForContact) > 0 then
 SET @campaginCodeForContacts = @existingContactCampaignCode

 ELSE
 SET @campaginCodeForContacts = Concat(@existingContactCampaignCode ,";", @campaginCodeForContact)
 ENDIF
 
 

 ENDIF
 ]%%

  <script runat="server">
  Platform.Load("Core", "1");
  
  
      
var submitted = Request.GetFormField("submitted")

if (submitted){ 


var access_token = Variable.GetValue("@SFSC_accestoken")  
var restUrl =  Variable.GetValue("@restUrl_link1")  

     
var campaignId = Variable.GetValue("campaignId")
var formnamevar = Variable.GetValue("formnamevar")

var firstname = Variable.GetValue("firstname")
var lastname = Variable.GetValue("lastname")
var companyname = Variable.GetValue("companyName")
var jobTitle = Variable.GetValue("jobTitle")
var emailAddress = Variable.GetValue("emailAddress")
var contactnumber = Variable.GetValue("contactnumber")
var companyZipvar = Variable.GetValue("companyZipvar")
var cars = Variable.GetValue("cars")
var trucks = Variable.GetValue("trucks")
var comments = Variable.GetValue("additionalInfo");
var campaignCode = Variable.GetValue("campaigncodevar")
var campaignId = Variable.GetValue("campaignIdvar")
 var privacy = 'True'
 var fs_Opt_In__c = 'true'
 var HasOptedOutOfEmail = 'false'
 var fs_Phone_Opt_In__c = 'true'
 var fs_HasOptedOutOfPhone__c = 'false'
 var thankyou = 'none'
 var thank_you_block = 'block'
 var country = 'Netherlands'
 var countryfield = 'NL'
 
 
 
 var access_token = Variable.GetValue("@lookuptoken")
var dunsnumber = Variable.GetValue("@duns")
var dunsapiurl = "https://plus.dnb.com/v1/data/duns/";
var dunsapiurl1 = dunsapiurl + dunsnumber + '?productId=cmpelk&versionId=v2';
    
var headerNames = ["Authorization"];
var headerValues = ["Bearer " + access_token];
var response = HTTP.Get(dunsapiurl1, headerNames, headerValues);
// Write("full XML 1:" + response.Content);
var array = response.Content;
      var responseparsed = Platform.Function.ParseJSON(response.Content);
      var industrycode = responseparsed.organization.industryCodes[0].code;
      var S_Principle = responseparsed.organization.mostSeniorPrincipals[0].fullName;
      var S_Principle_Job = responseparsed.organization.mostSeniorPrincipals[0].jobTitles[0].title;
      var S_Principle_Fname = responseparsed.organization.mostSeniorPrincipals[0].givenName;
      var S_Principle_gender = responseparsed.organization.mostSeniorPrincipals[0].gender;
      var S_Principle_Lname = responseparsed.organization.mostSeniorPrincipals[0].familyName;
      var S_Principle_Mgmt_Resp = responseparsed.organization.mostSeniorPrincipals[0].managementResponsibilities[0].description;
      var S_Principle_Suffix = responseparsed.organization.mostSeniorPrincipals[0].nameSuffix;
      var F_Tree = responseparsed.organization.corporateLinkage.familytreeRolesPlayed[0].description;
      var F_Hie_L_code = responseparsed.organization.corporateLinkage.hierarchyLevel;
      var F_Glo_Mem_count = responseparsed.organization.corporateLinkage.globalUltimateFamilyTreeMembersCount;
      var Global_Dun = responseparsed.organization.corporateLinkage.globalUltimate.duns;
      var Head_Dun = responseparsed.organization.corporateLinkage.headQuarter.duns;
      var Parent_Dun = responseparsed.organization.corporateLinkage.parent.duns;
     var Company_Reg = responseparsed.organization.registrationNumbers[0].registrationNumber;
    var numberOfEmployees = responseparsed.organization.numberOfEmployees[0].value;
     var websiteAddress = responseparsed.organization.websiteAddress[0].url;
  //  var telephoneNumber = responseparsed.organization.telephone[0].telephoneNumber;
    var dunsnumber_main = responseparsed.organization.duns;


    Variable.SetValue("@industrycode",industrycode);
    Variable.SetValue("@S_Principle",S_Principle);
    Variable.SetValue("@S_Principle_Job",S_Principle_Job);
    Variable.SetValue("@S_Principle_Fname",S_Principle_Fname);
    Variable.SetValue("@S_Principle_gender",S_Principle_gender);
    Variable.SetValue("@S_Principle_Lname",S_Principle_Lname);
    Variable.SetValue("@S_Principle_Mgmt_Resp",S_Principle_Mgmt_Resp);
    Variable.SetValue("@S_Principle_Suffix",S_Principle_Suffix);
    Variable.SetValue("@F_Tree",F_Tree);
    Variable.SetValue("@F_Hie_L_code",F_Hie_L_code);
    Variable.SetValue("@F_Glo_Mem_count",F_Glo_Mem_count);
    Variable.SetValue("@Global_Dun",Global_Dun);
    Variable.SetValue("@Head_Dun",Head_Dun);
    Variable.SetValue("@Parent_Dun",Parent_Dun);
    
     Variable.SetValue("@mainduns",dunsnumber_main);
    Variable.SetValue("@Company_Reg",Company_Reg);
     Variable.SetValue("@numberOfEmployees",numberOfEmployees);
    Variable.SetValue("@websiteAddress",websiteAddress);
  //  Variable.SetValue("@telephoneNumber",telephoneNumber);

  // get the match code and confidence code form 3rd API

  var dunsapiurl2 = 'https://plus.dnb.com/v1/match/cleanseMatch?registrationNumber=' + Company_Reg + '&countryISOAlpha2Code=NL&candidateMaximumQuantity=25';
  var response2 = HTTP.Get(dunsapiurl2, headerNames, headerValues);
// Write("Confidence Code XML:" + response2.Content);
  var array2 = response2.Content;
      var responseparsed2 = Platform.Function.ParseJSON(response2.Content);
      var confidenceCode = responseparsed2.matchCandidates[0].matchQualityInformation.confidenceCode;
      var matchGrade = responseparsed2.matchCandidates[0].matchQualityInformation.matchGrade;

 Variable.SetValue("@confidenceCode",confidenceCode);
 Variable.SetValue("@matchGrade",matchGrade);

 
 

 var payload = {
      
   "formdetails": {

      "formcode": "CMDdedupFormtest",

      "formdetails": "CMD dedup Form",

      "formname": "CMDdedupFormtest1"

   },

   "requestdata": {

  "firstname": firstname,
 "lastname":lastname,
 "company":companyname,
  "title":jobTitle,
 "email":emailAddress,
 "fs_business_unit_assignment__c":countryfield,
 "fs_contact_business_phone__c": contactnumber,
 "mobilephone": contactnumber,
 "postalcode":companyZipvar,
 "fs_cars__c":cars,
 "fs_vans__c":trucks,
 "fs_privacy_acceptance__c":privacy,
 "fs_opt_in__c":fs_Opt_In__c,
 "hasoptedoutofemail":HasOptedOutOfEmail,
 "fs_phone_opt_in__c":fs_Phone_Opt_In__c,
 "fs_hasoptedoutofphone__c":fs_HasOptedOutOfPhone__c,
 "fs_campaign_code__c":campaignCode,
 "fs_campaign_code_mktg__c":campaignCode,
 "fs_campaign_source__c": campaignId,
 "leadsource":'Web',
 "country":country,
 "fs_lead_comments__c":comments,
 "fs_d_b_number__c":dunsnumber_main,
 "fs_automatic_lead_conversion__c":"True"

     
    }
      
      

 };


  try {
    
   
    var result = HTTP.Post(restUrl, 'application/json', Stringify(payload), ["Authorization"], ["Bearer " + access_token]);
     var obj = Platform.Function.ParseJSON(result.Response[0]);
     var sfid = obj.id;
 //  var operation = obj['operation'];
    
 if (obj.object == "Lead"){
   var LeadID = obj.id;
   }
    else {
       var contactId = obj.id;
        }
    
    Variable.SetValue("@sfid",sfid);
    Variable.SetValue("@LeadID",LeadID);
    Variable.SetValue("@contactId",contactId);
    
    

      

    Write("firstname: " + firstname + "<br>");
     Write("lastname: " + lastname + "<br>");
     Write("companyname: " + companyname + "<br>");
     Write("jobTitle: " + jobTitle + "<br>");
     Write("emailAddress: " + emailAddress + "<br>");
    
     Write("contactnumber: " + contactnumber + "<br>");
     Write("companyZipvar: " + companyZipvar + "<br>");
     Write("cars: " + cars + "<br>");
     Write("trucks: " + trucks + "<br>");
     Write("additionalInfo: " + comments + "<br>");
     Write("privacy: " + privacy + "<br>");
     Write("fs_Opt_In__c: " + fs_Opt_In__c + "<br>");
     Write("HasOptedOutOfEmail: " + HasOptedOutOfEmail + "<br>");
     Write("fs_Phone_Opt_In__c: " + fs_Phone_Opt_In__c + "<br>");
     Write("fs_HasOptedOutOfPhone__c: " + fs_HasOptedOutOfPhone__c + "<br>");
     Write("country: " + country + "<br>");
     Write("countryfield: " + countryfield + "<br>");
    Write("campaignCode: " + campaignCode + "<br>");
    Write("campaignId: " + campaignId + "<br>");
    
  
    Write("result: " + result.Response[0] + "<br>");
  
  


    


  } catch (e) {
    Write("Exception: " + Stringify(e.message) + "<br>");
  }


} 
  
  
  
  
  
  

  </script> 

<script runat="server">
Platform.Load("Core","1");

  }
  catch (e) {
    Variable.SetValue("@errorMsg", Stringify(e.message));
         Variable.SetValue("@errorstate", true);
        
  }
</script>
  
